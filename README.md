# Модуль Telegram Notifier для OkayCMS

Модуль дозволяє отримувати сповіщення в Telegram про нові замовлення, оплачені замовлення, коментарі, зворотні зв'язки, заявки на дзвінок та щомісячну статистику замовлень з вашого інтернет-магазину.

## Можливості

### Миттєві сповіщення

- **Нове замовлення** — автоматична відправка при оформленні замовлення на сайті
- **Оплачене замовлення** — сповіщення, коли замовлення позначено як сплачене (зручно при онлайн-оплаті: колбек платіжної системи викликає оновлення `paid`, модуль відправляє підтвердження в Telegram)
- **Новий коментар** — сповіщення про коментарі до товарів та блогів
- **Зворотний зв'язок** — сповіщення про нові повідомлення через форму зворотного зв'язку
- **Заявка на дзвінок** — сповіщення про нові заявки на зворотний дзвінок

### Щомісячна статистика (крон)

- **Статистика замовлень** — щомісячний звіт за попередній місяць:
  - кількість замовлень;
  - загальна сума;
  - розбивка за статусами (всі статуси, у яких є замовлення за період);
  - топ 3 товари за кількістю проданих одиниць;
  - хештег `#order_stats` для швидкого пошуку в Telegram.
- Відправка **1-го числа кожного місяця о 9:00** (за умови налаштованого планувальника крон-завдань).

### Загальні можливості

- Окреме увімкнення/вимкнення кожного типу сповіщень
- **Формат відображення товару** для повідомлень про замовлення та оплачене замовлення: назва, назва (варіант), назва + артикул, назва (варіант) + артикул
- Форматування повідомлень у HTML з детальною інформацією
- Автоматичне обрізання повідомлень при перевищенні ліміту Telegram API (4096 символів)

## Вимоги

- OkayCMS v4.5.2
- Telegram Bot Token (отримати можна через [@BotFather](https://t.me/BotFather))
- Chat ID Telegram чату або користувача, куди будуть надсилатися сповіщення
- Для щомісячної статистики — налаштований планувальник крон-завдань (наприклад, `php console.php scheduler:run` щохвилини)

## Встановлення

### Варіант 1: Скачування з GitHub

1. Скачайте останню версію модуля з [останнього релізу на GitHub](https://github.com/devSviat/TelegramNotifier-OkayCMS/releases/latest).
2. Розпакуйте архів на сервері в каталог: `{OkayCMS_root}/Okay/Modules/`

### Варіант 2: Встановлення через Git

1. Виконайте команду в директорії `{OkayCMS_root}/Okay/Modules/Sviat`:
   ```bash
   git clone https://github.com/devSviat/TelegramNotifier-OkayCMS.git TelegramNotifier
   ```

### Результат встановлення

Шлях до модуля має бути таким:
```bash
{OkayCMS_root}/Okay/Modules/Sviat/TelegramNotifier/
```

Після встановлення перейдіть в адмін-панель → Модулі → Знайдіть «Telegram сповіщення» → Натисніть «Встановити»

## Налаштування

### Отримання Bot Token

1. Відкрийте Telegram та знайдіть бота [@BotFather](https://t.me/BotFather)
2. Надішліть команду `/newbot` та дотримуйтесь інструкцій
3. Після створення бота ви отримаєте токен у форматі: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`
4. Скопіюйте цей токен

### Отримання Chat ID

1. Додайте вашого бота до групи
2. Знайдіть бота [@getidsbot](https://t.me/getidsbot) та додайте його до групи
3. Бот покаже Chat ID групи (наприклад: `-1001234567890`)

### Налаштування модуля в адмін-панелі

1. Після встановлення модуля перейдіть в адмін-панель → Модулі → Telegram сповіщення
2. Заповніть обов'язкові поля:
   - **Bot Token** — токен вашого Telegram бота
   - **Chat ID** — ID чату або користувача, куди будуть надсилатися сповіщення
3. Увімкніть потрібні типи сповіщень:
   - ✅ Нове замовлення
   - ✅ Оплачене замовлення (при позначенні замовлення як сплачене, зокрема після онлайн-оплати)
   - ✅ Сповіщення про нові коментарі
   - ✅ Сповіщення про зворотні зв'язки
   - ✅ Сповіщення про заявки на дзвінок
   - ✅ Статистика замовлень (щомісячний звіт 1-го числа о 9:00)
4. Оберіть **формат відображення товару** для повідомлень про замовлення та оплачене замовлення
5. Натисніть «Зберегти»

## Використання

### Миттєві сповіщення

Модуль автоматично відправляє повідомлення в Telegram при таких подіях:

- **Нове замовлення** — при оформленні замовлення клієнтом
- **Оплачене замовлення** — при позначенні замовлення як сплачене (наприклад, після колбеку платіжної системи). Сповіщення відправляється лише один раз при зміні статусу оплати на «сплачено»
- **Новий коментар** — при додаванні коментаря до товару або блогу
- **Зворотний зв'язок** — при відправці форми зворотного зв'язку
- **Заявка на дзвінок** — при залишенні заявки на зворотний дзвінок

### Щомісячна статистика

Якщо увімкнено «Статистика замовлень», 1-го числа кожного місяця о 9:00 (за розкладом крона) у Telegram надсилається звіт за **попередній** місяць:

- кількість замовлень;
- сума замовлень;
- розбивка за статусами (усі статуси з замовленнями за період);
- топ 3 товари за кількістю проданих одиниць;
- хештег `#order_stats` в кінці повідомлення для пошуку.

Для роботи щомісячного звіту необхідно, щоб на сервері виконувався планувальник крон-завдань OkayCMS.

## Важливо

- Якщо повідомлення перевищує 4096 символів, воно автоматично обрізається
- Переконайтеся, що Bot Token та Chat ID введені правильно, інакше сповіщення не будуть надсилатися
- Сповіщення про оплачене замовлення відправляється лише при реальній зміні статусу оплати на «сплачено» (не при повторній позначці вже оплаченого замовлення)

## Ліцензія

Модуль розповсюджується за вільною ліцензією MIT
